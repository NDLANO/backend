notifications:
  slack:
    on_success: change
    on_failure: always
    rooms:
      secure: EJsRVf5diVC52ynXCjfKIp/nfe/Bd/He8J51BFPxFtR2PtTZF/Udo4Utzy0vt5/XHymLZTPKQeWReprjMltEnYttU8oX86SqrIiX7e+DdsI3ZExTBHFVlAJIqcaACG27THLkgyrljpDA9aMleHhWE76+SAKdH4fcAWC9jIQrhY7+/e4VgeCA7idx084Sbz+VlP8o7EKYGIK61d/U5CS1dpT9ZtNjPZ4jm8XP3DH9h74W5SPIf/ozlATurezUvx7PjlXUSmL3d8vlS5QsoXfMPssvQkZ9WhvYgkShxyBBMcm+mmyhYaVD5/ogX73dIWSTAZDB35VYTvPzAqe7OEy6tYqAosSim6Jly8z63HnceF7r9/MNdfp3eIOFmMOWzXt+Hax83mRflsHctHUBlOQhD3niGL75Vx4MSvb17jlMhGLJyY/06B+48fvS6qs1aaDmQMwRAuwnbHdbAKkOOUMHg9VuFsqFPyXiKWxfeibZHkVu+FI4H6P4n2+PmXgnYD/pOxXrOIq19QgkRDyQzJyooCZAgotf42HTESZm5MxhGOh+xYEuc7Rk9BbS1COHHJiUMfkyCryqv1arN3n4Cfqd+9R70MHza4cja9+wvm2FMwkf0SnEx21cnRfZ0hpByK7OH2s212g5aPqkWwzBUM9VCXCZNEVJ+yvkPq4pBP8yAvw=
matrix:
  fast_finish: true
  include:

    - name: "Unit tests with pact publication"
      script: sbt ++$TRAVIS_SCALA_VERSION pactPublish
      language: scala
      dist: focal
      scala: 2.13.3
      jdk:
        - openjdk11
      cache:
        directories:
          - $HOME/.ivy2/cache
          - $HOME/.sbt/boot/
      before_cache:
        # Tricks to avoid unnecessary cache updates
        - find $HOME/.ivy2 -name "ivydata-*.properties" -delete
        - find $HOME/.sbt -name "*.lock" -delete
      before_script:
        - echo $DOCKER_HUB_PASSWORD | docker login --username $DOCKER_HUB_USERNAME --password-stdin

    - name: "Release"
      language: python
      if: branch = master AND type = push
      python: 3.7
      dist: focal
      services:
        - docker
      cache:
        pip: true
        directories:
          - $HOME/.ivy2/cache
          - $HOME/.sbt/boot/
      before_install:
        # Authenticate docker client to deploy aws registry
        - pip install awscli
        - $(aws ecr get-login --no-include-email --region eu-west-1)

        # Fetch deploy repo
        - git clone --depth 1 https://knowit-at-ndla:$TRAVIS_RELEASE_GITHUB_TOKEN@github.com/ndlano/deploy.git ../deploy

        # Setup env
        - export NDLA_HOME=$(realpath $(pwd)/../)
        - export NDLA_DEPLOY=$NDLA_HOME/deploy
        - export DEPLOY_VERSION=$(git -C $NDLA_DEPLOY rev-parse --short=7 HEAD)
        - export DEPLOY_DOCKER_REPO=784120951859.dkr.ecr.eu-west-1.amazonaws.com/ndla/deploy

        # Get cache, and don't fail if missing
        - docker pull $DEPLOY_DOCKER_REPO:$DEPLOY_VERSION || true
      install:
        - eval "$($NDLA_DEPLOY/scripts/bin/ndla init -)"
      env:
        - SSH_AUTH_SOCK=/tmp/mock_sock
      script:
        - ndla release search-api --update-chart
      before_cache: # Save docker image as cache
        - docker push $DEPLOY_DOCKER_REPO:$DEPLOY_VERSION

        # Tricks to avoid unnecessary cache updates
        - find $HOME/.ivy2 -name "ivydata-*.properties" -delete
        - find $HOME/.sbt -name "*.lock" -delete
      before_script:
        - echo $DOCKER_HUB_PASSWORD | docker login --username $DOCKER_HUB_USERNAME --password-stdin

  allow_failures:
      - name: "Release"
    
